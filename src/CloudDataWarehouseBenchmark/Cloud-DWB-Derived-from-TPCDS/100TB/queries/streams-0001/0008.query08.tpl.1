
select /* query_templates/query08.tpl.0 !CF:IR-c4b99a30-f08a-11e9-b661-06872b3fecc8..stream-query.streams-0001.i0008.1.0:CF! */  s_store_name
      ,sum(ss_net_profit)
 from public.store_sales
     ,public.date_dim
     ,public.store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM public.customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '77454','13128','57912','45114','61445','33016',
                          '58786','40720','48604','18245','91696',
                          '19427','18856','57505','19447','20007',
                          '19657','17874','57662','12309','52988',
                          '32065','61096','15986','44603','54034',
                          '81072','91783','67511','38658','50045',
                          '40410','34822','49383','23609','66659',
                          '31968','24174','85381','72396','95731',
                          '63960','75337','11941','69837','97190',
                          '90134','80427','45012','41899','46533',
                          '99585','82408','28876','17037','98042',
                          '84389','75352','53049','69199','47159',
                          '68817','67604','43627','43971','33282',
                          '74748','95560','38384','26663','58162',
                          '86094','36106','82926','82199','25918',
                          '63758','51042','20665','27425','65375',
                          '51140','22665','32572','73050','59394',
                          '85495','60480','61861','82161','98463',
                          '51171','53014','17679','57490','25747',
                          '60633','71210','75312','39458','83804',
                          '58844','24563','88359','18326','92290',
                          '41995','38035','20654','64016','97155',
                          '33896','97851','88375','92661','34067',
                          '11118','95963','27861','92776','83960',
                          '25671','66218','20768','81174','77054',
                          '19573','42470','59310','20945','95235',
                          '89910','90300','91987','12299','87690',
                          '49831','14711','86398','57299','19895',
                          '11727','18224','84145','10453','48446',
                          '56769','25316','20358','26423','18808',
                          '75554','79574','81102','91629','60874',
                          '29603','69393','96485','32884','23339',
                          '38878','66053','70979','17420','40308',
                          '59133','61895','69325','39630','28179',
                          '51633','39171','31387','37030','66002',
                          '78855','25835','89214','55048','61249',
                          '70299','74884','14784','64430','35574',
                          '36220','18651','27357','43133','26580',
                          '64961','10220','51639','43345','95962',
                          '47376','17625','13515','94136','92059',
                          '33011','35341','12503','42787','87561',
                          '54820','40302','70430','73735','16852',
                          '34854','75949','45461','28919','46547',
                          '26127','87933','44582','79075','43900',
                          '99810','50455','82788','48185','37599',
                          '44845','46896','88874','67364','45749',
                          '58605','29570','59711','54294','43706',
                          '12902','76344','22843','55716','50921',
                          '94232','65823','72664','84655','74152',
                          '39882','51944','23759','38002','16816',
                          '72568','74202','97320','48287','45714',
                          '36489','15623','78049','64439','26448',
                          '72117','18289','92609','83184','79999',
                          '59784','40353','67641','32844','15291',
                          '67179','87928','86053','54235','55062',
                          '83773','59660','68310','34038','70319',
                          '42382','54318','78468','75963','97597',
                          '69993','35297','15770','90800','70816',
                          '77854','16060','67207','94430','30613',
                          '69324','65000','98795','25445','37657',
                          '26828','56118','13635','84779','86667',
                          '40202','17863','89523','11033','97983',
                          '19245','76991','42492','19139','74847',
                          '43879','37906','43099','15598','33336',
                          '27573','13022','19312','56216','79831',
                          '95888','64152','20726','32613','61623',
                          '33998','29562','33478','59530','35313',
                          '54491','55221','72609','64051','43804',
                          '80353','90357','20352','50795','58814',
                          '83102','88783','63097','27950','16226',
                          '15813','96663','26099','24071','93710',
                          '53656','83486','15760','19724','10389',
                          '63116','82009','40588','17459','31512',
                          '77525','98275','53088','68553','73540',
                          '64437','45551','18428','32803','14383',
                          '72892','30378','18005','65271','18763',
                          '43634','51009','31529','17949','60196',
                          '58588','94139','27430','71318','88502',
                          '26429','87225','84730','98236','59607',
                          '70937','81669','32179','45829')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM public.customer_address, public.customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
