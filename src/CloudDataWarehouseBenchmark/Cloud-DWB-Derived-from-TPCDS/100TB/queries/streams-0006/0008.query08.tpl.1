
select /* query_templates/query08.tpl.0 !CF:IR-c4b99a30-f08a-11e9-b661-06872b3fecc8..stream-query.streams-0006.i0008.1.0:CF! */  s_store_name
      ,sum(ss_net_profit)
 from public.store_sales
     ,public.date_dim
     ,public.store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM public.customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '41282','51165','87701','41129','34812','79740',
                          '16415','71185','68823','66786','61388',
                          '14612','70904','65865','84652','55554',
                          '87168','22998','85948','39129','62429',
                          '33446','58575','26736','65568','38249',
                          '82788','68245','91131','99997','36494',
                          '75244','65507','54902','40274','54441',
                          '57736','82785','88467','58804','78179',
                          '80838','86512','26667','73254','76877',
                          '67177','32769','53139','94157','65540',
                          '64887','89119','86166','37318','51849',
                          '91277','43260','47249','48682','62427',
                          '10588','30033','38189','60276','61447',
                          '66559','46406','80730','67467','31617',
                          '15036','45670','96225','78139','34428',
                          '83909','63480','97723','52928','12056',
                          '56232','62783','70245','88288','71815',
                          '40957','24791','50653','51797','61747',
                          '71293','65745','43235','62900','59324',
                          '79289','85938','51920','34925','18491',
                          '90429','76921','74539','13007','97067',
                          '79114','51175','57613','11626','13706',
                          '66548','72383','67678','77034','38979',
                          '80724','58171','92383','73394','39288',
                          '71243','75946','76660','80245','43126',
                          '49245','73983','25826','66762','36825',
                          '46575','32822','97411','56615','98904',
                          '71555','37570','45888','99665','96813',
                          '89493','25349','66918','82309','79066',
                          '15325','77879','39335','41309','79389',
                          '17987','90762','29251','41118','44664',
                          '59325','70254','84927','62076','56235',
                          '13760','99776','32238','50380','47671',
                          '17265','86059','12873','94717','26284',
                          '96011','26190','13108','16103','84082',
                          '87000','61339','28422','35957','44074',
                          '22643','66793','92514','59343','29308',
                          '86581','54419','47073','79147','25071',
                          '14544','94303','67948','70213','59602',
                          '31057','94607','36957','34989','17486',
                          '45084','81403','20474','36299','84604',
                          '47980','57388','35801','87368','63611',
                          '92294','66393','90511','19853','70556',
                          '83700','93394','60141','52691','61718',
                          '16899','26695','93740','68635','62944',
                          '48980','80437','91966','27862','83618',
                          '63128','30297','16336','20689','25807',
                          '86953','41038','49601','91099','89707',
                          '14575','65960','51906','92884','83659',
                          '31538','65521','10990','88235','76659',
                          '48798','79060','66517','70102','93363',
                          '35188','37536','80957','11212','21849',
                          '87441','74247','15171','29485','14620',
                          '47690','68063','17184','42713','25612',
                          '34185','27089','93590','56415','91931',
                          '65785','46217','40608','70624','62634',
                          '18653','27598','72361','21621','83731',
                          '95993','92403','93968','55726','58853',
                          '29046','52429','46225','66520','27786',
                          '79273','58577','31292','66839','41833',
                          '16719','39666','75177','35458','15158',
                          '39197','36533','61062','10037','32587',
                          '69416','76585','85959','94570','18015',
                          '72836','10419','23073','83762','37119',
                          '94238','16512','34990','75333','29423',
                          '79269','13933','52651','27378','13988',
                          '83934','49670','39480','15583','41793',
                          '18087','61771','29022','57218','18707',
                          '41827','31510','13056','33121','55356',
                          '60407','57366','88010','63500','37905',
                          '31811','88283','49475','14662','48414',
                          '44818','84436','45820','34719','85889',
                          '58154','43234','75897','44523','33981',
                          '47590','77012','35631','51102','90541',
                          '30328','59576','60137','18818','70007',
                          '50698','25270','97450','22366','35623',
                          '58599','69352','66706','90049','47646',
                          '70124','62891','13629','80714','30925',
                          '30553','60295','99363','64296','16549',
                          '15276','23612','98410','75061')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM public.customer_address, public.customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
