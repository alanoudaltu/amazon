
select /* query_templates/query08.tpl.0 !CF:IR-c4b99a30-f08a-11e9-b661-06872b3fecc8..stream-query.streams-0004.i0008.1.0:CF! */  s_store_name
      ,sum(ss_net_profit)
 from public.store_sales
     ,public.date_dim
     ,public.store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM public.customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '58417','74742','14863','98124','44359','39230',
                          '52208','11931','45050','98076','35688',
                          '75216','90734','95658','66596','40395',
                          '76910','20165','25712','92949','43952',
                          '68814','49876','70754','79217','82736',
                          '36398','71000','30013','52629','81617',
                          '54273','18117','96558','51341','81333',
                          '26092','74809','18214','17651','10593',
                          '60092','30026','73375','65721','94326',
                          '56997','72503','26413','47874','31607',
                          '31605','85545','58698','43780','52979',
                          '89665','22635','49108','38492','74428',
                          '96684','34282','76883','63328','71210',
                          '99888','18977','98957','24068','93709',
                          '89549','29244','21556','32001','75027',
                          '21542','12791','33275','72918','43290',
                          '68389','69296','81729','19559','15815',
                          '64611','38566','47213','75458','23504',
                          '86413','36039','56309','80542','66613',
                          '19118','14607','42844','26192','32137',
                          '86371','10379','55630','20607','45092',
                          '76466','48515','77047','84038','64829',
                          '32234','82670','82043','12823','56092',
                          '88595','98972','89741','60475','99092',
                          '60809','24750','71129','63705','97456',
                          '79103','40530','46271','27869','66822',
                          '37093','12244','23125','60904','38154',
                          '48700','90679','45354','26981','75173',
                          '89457','90159','44715','57181','22553',
                          '47898','12453','52245','83174','44219',
                          '57947','84046','93552','49371','95673',
                          '43854','97402','83778','50569','90120',
                          '52066','34446','54628','13576','37998',
                          '13738','84125','16388','77137','90846',
                          '42606','35565','79615','28630','81429',
                          '19855','53154','58291','76984','27635',
                          '44365','77784','93901','34119','84426',
                          '97977','68084','57476','34049','97917',
                          '38996','20914','97019','18210','52131',
                          '77860','52988','46206','19965','83948',
                          '55073','20894','75209','53502','82203',
                          '87688','59562','52772','27965','20940',
                          '50961','38887','41137','29083','53940',
                          '44557','15267','55355','92911','25344',
                          '76552','40011','23029','75035','12865',
                          '26152','25913','92620','17912','74430',
                          '64111','88101','44725','87634','20567',
                          '75770','12292','76125','86316','89642',
                          '79774','22713','92330','78869','55567',
                          '71769','66492','45986','40791','44371',
                          '10680','23582','24428','61984','36288',
                          '43696','76017','91041','20711','70970',
                          '87358','48010','12420','53336','95104',
                          '42901','41386','60158','29102','33769',
                          '36265','55889','58699','15320','42269',
                          '82912','38743','51506','97116','62552',
                          '17835','47914','75766','28457','82131',
                          '17473','25355','91845','33081','63359',
                          '84159','57457','91199','59752','34426',
                          '12877','61918','49920','75426','88823',
                          '21323','26964','88414','57944','79332',
                          '82943','61424','43220','93916','62988',
                          '44519','48680','23933','80661','38057',
                          '11949','48916','94207','76663','17445',
                          '87086','13626','62460','58418','21081',
                          '19470','93930','28611','50139','42904',
                          '24461','84761','82355','63073','30431',
                          '93430','63532','67509','68688','80394',
                          '10626','56998','47205','51778','22919',
                          '17930','61990','41389','17613','99053',
                          '50788','23909','43915','83326','95058',
                          '52839','23275','36042','56551','34962',
                          '44772','66528','61676','36554','78636',
                          '87101','43788','29449','42513','73279',
                          '57622','73310','76956','21361','45443',
                          '32327','65988','48156','72357','82811',
                          '91594','17196','24317','93359','40952',
                          '98992','46571','60784','11040','38607',
                          '14124','63756','36417','55129','81100',
                          '78634','66428','32820','97026')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM public.customer_address, public.customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
