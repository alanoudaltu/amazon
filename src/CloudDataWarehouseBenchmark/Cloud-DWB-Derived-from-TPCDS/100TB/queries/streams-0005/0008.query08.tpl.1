
select /* query_templates/query08.tpl.0 !CF:IR-c4b99a30-f08a-11e9-b661-06872b3fecc8..stream-query.streams-0005.i0008.1.0:CF! */  s_store_name
      ,sum(ss_net_profit)
 from public.store_sales
     ,public.date_dim
     ,public.store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM public.customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '81690','12824','14392','49289','14013','99334',
                          '72811','41362','48342','79795','11951',
                          '79674','26251','59906','71019','48237',
                          '85770','89473','55576','71145','45846',
                          '19810','75987','64041','14915','84987',
                          '13749','52768','15088','86371','15264',
                          '67560','70728','89867','92678','57804',
                          '58543','52297','71105','70181','69130',
                          '94835','27811','17692','65419','46219',
                          '62751','58969','79021','43121','14500',
                          '79011','93215','64862','97396','20227',
                          '47917','72789','68060','69866','89113',
                          '28408','46074','93642','95524','39895',
                          '47716','48872','50868','26271','93949',
                          '53116','22972','14742','76097','66636',
                          '34887','85624','97927','41915','16824',
                          '37436','79258','95627','73309','90774',
                          '32206','56608','37790','23253','17948',
                          '95209','39537','87165','90561','11256',
                          '83329','24100','69865','88909','30484',
                          '61631','19269','91148','19541','86973',
                          '98243','33896','42556','33557','57175',
                          '52294','19387','52465','76351','79486',
                          '51410','89099','49446','12893','22371',
                          '21712','21345','45171','10803','14887',
                          '83683','34605','37599','93406','40212',
                          '12735','27429','71285','11395','82607',
                          '89106','72665','12228','21028','20964',
                          '41837','44848','57850','58263','75513',
                          '21033','34784','79512','95832','96468',
                          '52876','32292','52391','94865','26968',
                          '85142','99127','81917','47652','89598',
                          '74879','41472','37074','25275','46397',
                          '68352','94582','95647','80233','36046',
                          '20549','31961','81004','15438','84076',
                          '27487','91809','55534','56572','15142',
                          '16383','45059','13114','71592','43347',
                          '28498','92947','23716','79023','23491',
                          '89454','69233','82340','13415','92419',
                          '63894','10921','10867','30021','37525',
                          '83991','54138','14509','36198','49840',
                          '94742','99110','81760','49078','45681',
                          '12929','81967','69107','15698','25892',
                          '81345','91336','32980','82950','34289',
                          '77706','42677','14226','48897','97816',
                          '33424','52387','91209','32328','37480',
                          '10141','27520','65452','56995','87648',
                          '83204','47961','54707','22558','98326',
                          '25801','25635','13934','59106','93382',
                          '28595','45320','84398','25711','67983',
                          '25653','46171','70235','55969','32349',
                          '44476','54494','71158','25680','11244',
                          '99595','46168','44993','88428','93189',
                          '29263','55200','11316','96207','83874',
                          '41890','30909','35465','13993','62602',
                          '92436','55675','30806','33452','75754',
                          '45787','66870','69229','41257','69857',
                          '55565','95636','90070','80765','74000',
                          '40369','70876','25926','73906','43581',
                          '48234','41511','39765','84217','28262',
                          '99728','29352','85483','61244','77246',
                          '77013','59626','61963','89896','28139',
                          '40298','98083','39276','52224','38276',
                          '91731','60195','57623','41723','96814',
                          '66084','15298','87712','70105','82937',
                          '29147','17764','80525','94673','95971',
                          '87299','65562','28933','61865','96617',
                          '57442','43689','48760','54871','27151',
                          '68642','15908','77441','69891','67806',
                          '42835','84149','91990','93141','74736',
                          '21233','34415','39402','83282','99378',
                          '46276','87530','61345','92840','78711',
                          '98121','28277','85472','32280','91376',
                          '78321','41206','56762','57262','75696',
                          '27681','21666','85207','45495','70487',
                          '76672','36735','15616','69371','52106',
                          '77968','31656','80461','85482','72318',
                          '76935','52935','64805','16364','50619',
                          '36781','37156','97732','18157','77770',
                          '71939','97557','41774','49426')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM public.customer_address, public.customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
