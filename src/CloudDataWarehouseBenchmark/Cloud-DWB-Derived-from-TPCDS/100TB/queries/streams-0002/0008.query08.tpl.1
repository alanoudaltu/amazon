
select /* query_templates/query08.tpl.0 !CF:IR-c4b99a30-f08a-11e9-b661-06872b3fecc8..stream-query.streams-0002.i0008.1.0:CF! */  s_store_name
      ,sum(ss_net_profit)
 from public.store_sales
     ,public.date_dim
     ,public.store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM public.customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '23363','58684','15009','16853','82998','55215',
                          '91688','19710','65534','13965','82636',
                          '67651','62072','96896','78721','41396',
                          '23670','82218','52232','48405','92926',
                          '37694','24788','29226','26247','19032',
                          '32785','37040','37516','82226','28143',
                          '82536','39234','78929','35146','55979',
                          '46872','24824','90722','67545','44446',
                          '75536','97581','29011','49327','17360',
                          '66535','92620','62667','51524','75007',
                          '99929','90474','37934','42169','14255',
                          '80342','27043','63621','91141','10946',
                          '62567','73959','58340','94259','76376',
                          '92423','77617','74908','54533','82417',
                          '40835','76542','46515','90940','36696',
                          '69000','48265','44010','98057','16114',
                          '88255','72256','12649','90883','81732',
                          '37764','52483','52075','75282','65970',
                          '78413','90806','90330','35742','52508',
                          '41033','71929','54150','46287','61633',
                          '83724','65951','36531','71611','97316',
                          '46905','30007','21718','62816','96456',
                          '91491','73248','87833','25208','59583',
                          '61125','58664','82700','62807','53318',
                          '57827','51837','69950','25849','23301',
                          '54269','39442','49238','12755','96727',
                          '44113','71960','13482','71476','24652',
                          '93079','11822','90093','24328','38262',
                          '46364','29774','38136','48537','42252',
                          '74102','87152','32932','12736','43415',
                          '12381','97287','55614','71291','48021',
                          '29791','13458','98164','26744','90965',
                          '67196','80545','11732','66979','14028',
                          '33462','83381','93507','72461','88378',
                          '15756','60622','44646','68975','55194',
                          '67157','50219','74258','40541','34114',
                          '32846','33521','67140','31036','66662',
                          '84066','77269','28558','77485','68869',
                          '62222','75408','18613','54842','21844',
                          '72176','24131','90046','47481','71395',
                          '40276','91178','82259','58293','86024',
                          '49954','83069','17028','66658','61435',
                          '55732','42131','96177','36827','83810',
                          '43114','55646','97271','66360','43713',
                          '93282','27710','49626','63392','41208',
                          '50958','44604','22108','54141','45115',
                          '74313','34209','89148','42698','17253',
                          '15526','14944','59092','86545','93611',
                          '42885','38503','64324','40881','21856',
                          '87476','81850','95953','41817','17040',
                          '87389','21652','92147','44990','20740',
                          '61045','70577','58763','69430','16745',
                          '26922','13690','94678','30131','70994',
                          '74802','79517','39593','96845','13650',
                          '99003','32102','72884','92540','32355',
                          '33936','82216','18405','19937','64299',
                          '25435','47455','14344','38384','87885',
                          '74916','82194','10620','37908','89043',
                          '19698','63018','83971','97882','15118',
                          '61755','51585','76369','98684','90813',
                          '57397','13726','60735','38320','40482',
                          '80095','48036','70618','13461','72927',
                          '50169','69161','95504','97378','99857',
                          '85575','61206','88520','24679','78177',
                          '91314','27019','33865','49713','57595',
                          '45880','69856','92371','34389','26132',
                          '54103','58349','29809','17898','31413',
                          '86515','47671','29823','55792','98898',
                          '23696','28047','68701','34405','72006',
                          '81509','70088','46091','94177','28090',
                          '94936','51353','27251','70190','69706',
                          '28379','59759','65297','67830','56129',
                          '56814','78940','73892','53300','61354',
                          '71544','33356','68271','21443','20729',
                          '85981','17553','27048','72645','73989',
                          '78325','47914','47323','62236','80778',
                          '70945','14849','18806','50279','94718',
                          '55318','47125','90620','35258','27987',
                          '74929','45302','12002','60061','57505',
                          '28657','63556','19874','39877')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM public.customer_address, public.customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
